services:
  # PostgreSQL Database for Identity Service
  identity-db:
    image: postgres:16-alpine
    container_name: identity-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${IDENTITY_DB_NAME:-IdentityDb}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-123123}
    ports:
      - "5436:5432"
    volumes:
      - identity-db-data:/var/lib/postgresql/data
    networks:
      - app-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL Database for Appointment Service
  appointment-db:
    image: postgres:16-alpine
    container_name: appointment-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${APPOINTMENT_DB_NAME:-appointmentdb}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-123123}
    ports:
      - "5433:5432"
    volumes:
      - appointment-db-data:/var/lib/postgresql/data
    networks:
      - app-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL Database for Chat Service
  chat-db:
    image: postgres:16-alpine
    container_name: chat-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${CHAT_DB_NAME:-chatappdb}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-123123}
    ports:
      - "5434:5432"
    volumes:
      - chat-db-data:/var/lib/postgresql/data
    networks:
      - app-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL Database for Notification Service
  notification-db:
    image: postgres:16-alpine
    container_name: notification-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${NOTIFICATION_DB_NAME:-notificationdb}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-123123}
    ports:
      - "5435:5432"
    volumes:
      - notification-db-data:/var/lib/postgresql/data
    networks:
      - app-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL Database for Document Service
  document-db:
    image: postgres:16-alpine
    container_name: document-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${DOCUMENT_DB_NAME:-DocumentDb}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-123123}
    ports:
      - "5437:5432"
    volumes:
      - document-db-data:/var/lib/postgresql/data
    networks:
      - app-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # # PostgreSQL Database for Automation Service (DISABLED - source code missing)
  # automation-db:
  #   image: postgres:16-alpine
  #   container_name: automation-db
  #   restart: unless-stopped
  #   environment:
  #     POSTGRES_DB: ${AUTOMATION_DB_NAME:-automationdb}
  #     POSTGRES_USER: ${POSTGRES_USER:-postgres}
  #     POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-123123}
  #   ports:
  #     - "5438:5432"
  #   volumes:
  #     - automation-db-data:/var/lib/postgresql/data
  #   networks:
  #     - app-network
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U postgres"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5

  # MinIO Object Storage for avatars and documents
  minio:
    image: minio/minio:latest
    container_name: minio
    restart: unless-stopped
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio-data:/data
    networks:
      - app-network
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -f http://localhost:9000/minio/health/live || exit 1",
        ]
      interval: 30s
      timeout: 10s
      retries: 5

  # Identity Service
  identity-service:
    build:
      context: ./Identity
      dockerfile: Dockerfile
    container_name: identity-service
    restart: unless-stopped
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:5005
      - ConnectionStrings__DefaultConnection=Host=identity-db;Port=5432;Database=${IDENTITY_DB_NAME:-IdentityDb};Username=${POSTGRES_USER:-postgres};Password=${POSTGRES_PASSWORD:-123123}
      - Jwt__SecretKey=${JWT_SECRET_KEY:-YourSuperSecretKeyThatIsAtLeast32CharactersLongForIdentityService!}
      - Jwt__Issuer=${JWT_ISSUER:-IdentityApp}
      - Jwt__Audience=${JWT_AUDIENCE:-IdentityAppClients}
      - Jwt__AccessTokenExpirationMinutes=${JWT_ACCESS_EXPIRATION:-30}
      - Jwt__RefreshTokenExpirationDays=${JWT_REFRESH_EXPIRATION:-7}
      - NotificationService__BaseUrl=http://notification-service:5003
      - Frontend__PublicBaseUrl=${FRONTEND_PUBLIC_BASE_URL:-http://localhost:8080}
      - IdentityService__PublicBaseUrl=${IDENTITY_PUBLIC_BASE_URL:-http://localhost:5005}
      - Minio__Endpoint=${MINIO_ENDPOINT:-minio:9000}
      - Minio__AccessKey=${MINIO_ROOT_USER:-minioadmin}
      - Minio__SecretKey=${MINIO_ROOT_PASSWORD:-minioadmin}
      - Minio__Bucket=${MINIO_BUCKET:-avatars}
      - Minio__UseSsl=${MINIO_USE_SSL:-false}
      - Minio__PublicBaseUrl=${MINIO_PUBLIC_BASE_URL:-http://localhost:9000}
      - Smtp__Host=${SMTP_HOST:-mail.kubzle.com}
      - Smtp__Port=${SMTP_PORT:-587}
      - Smtp__Username=${SMTP_USERNAME:-Test-internship@rts.md}
      - Smtp__Password=${SMTP_PASSWORD:-5517bBueeT8z}
      - Smtp__FromEmail=${SMTP_FROM_EMAIL:-Test-internship@rts.md}
      - Smtp__FromName=${SMTP_FROM_NAME:-Booking-app}
      - Smtp__SecureSocket=${SMTP_SECURE_SOCKET:-StartTls}
      - Smtp__UseSsl=false
      - Smtp__UseStartTls=true
      - SeedAdmin__Email=${SEED_ADMIN_EMAIL:-admin@appointment-app.com}
      - SeedAdmin__Password=${SEED_ADMIN_PASSWORD:-Admin123!}
      - SeedAdmin__UserName=${SEED_ADMIN_USERNAME:-admin}
      - SeedAdmin__FirstName=${SEED_ADMIN_FIRSTNAME:-System}
      - SeedAdmin__LastName=${SEED_ADMIN_LASTNAME:-Admin}
      - SeedAdmin__ResetPasswordOnStartup=${SEED_ADMIN_RESET_PASSWORD_ON_STARTUP:-false}
    ports:
      - "5005:5005"
    depends_on:
      identity-db:
        condition: service_healthy
      minio:
        condition: service_healthy
    networks:
      - app-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5005/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Appointment Service
  appointment-service:
    build:
      context: .
      dockerfile: Appointment/Dockerfile
    container_name: appointment-service
    restart: unless-stopped
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:5001
      - ConnectionStrings__DefaultConnection=Host=appointment-db;Port=5432;Database=${APPOINTMENT_DB_NAME:-appointmentdb};Username=${POSTGRES_USER:-postgres};Password=${POSTGRES_PASSWORD:-123123}
      - IdentityService__BaseUrl=http://identity-service:5005
      - NotificationService__BaseUrl=http://notification-service:5003
      - Jwt__SecretKey=${JWT_SECRET_KEY:-YourSuperSecretKeyThatIsAtLeast32CharactersLongForIdentityService!}
      - Jwt__Issuer=${JWT_ISSUER:-IdentityApp}
      - Jwt__Audience=${JWT_AUDIENCE:-IdentityAppClients}
      - Jwt__ExpirationMinutes=${JWT_ACCESS_EXPIRATION:-30}
    ports:
      - "5001:5001"
    depends_on:
      appointment-db:
        condition: service_healthy
      identity-service:
        condition: service_healthy
    networks:
      - app-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5001/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Chat Service
  chat-service:
    build:
      context: ./ChatApp
      dockerfile: Dockerfile
    container_name: chat-service
    restart: unless-stopped
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:5002
      - ConnectionStrings__DefaultConnection=Host=chat-db;Port=5432;Database=${CHAT_DB_NAME:-chatappdb};Username=${POSTGRES_USER:-postgres};Password=${POSTGRES_PASSWORD:-123123}
      - IdentityService__BaseUrl=http://identity-service:5005
      - NotificationService__BaseUrl=http://notification-service:5003
      - Jwt__SecretKey=${JWT_SECRET_KEY:-YourSuperSecretKeyThatIsAtLeast32CharactersLongForIdentityService!}
      - Jwt__Issuer=${JWT_ISSUER:-IdentityApp}
      - Jwt__Audience=${JWT_AUDIENCE:-IdentityAppClients}
    ports:
      - "5002:5002"
    depends_on:
      chat-db:
        condition: service_healthy
      identity-service:
        condition: service_healthy
    networks:
      - app-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5002/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Notification Service
  notification-service:
    build:
      context: ./Notification
      dockerfile: Dockerfile
    container_name: notification-service
    restart: unless-stopped
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:5003
      - ConnectionStrings__DefaultConnection=Host=notification-db;Port=5432;Database=${NOTIFICATION_DB_NAME:-notificationdb};Username=${POSTGRES_USER:-postgres};Password=${POSTGRES_PASSWORD:-123123}
      - IdentityService__BaseUrl=http://identity-service:5005
      - Jwt__SecretKey=${JWT_SECRET_KEY:-YourSuperSecretKeyThatIsAtLeast32CharactersLongForIdentityService!}
      - Jwt__Issuer=${JWT_ISSUER:-IdentityApp}
      - Jwt__Audience=${JWT_AUDIENCE:-IdentityAppClients}
      - Smtp__Host=${SMTP_HOST:-mail.kubzle.com}
      - Smtp__Port=${SMTP_PORT:-587}
      - Smtp__Username=${SMTP_USERNAME:-Test-internship@rts.md}
      - Smtp__Password=${SMTP_PASSWORD:-5517bBueeT8z}
      - Smtp__FromEmail=${SMTP_FROM_EMAIL:-Test-internship@rts.md}
      - Smtp__FromName=${SMTP_FROM_NAME:-Booking-app}
      - Smtp__SecureSocket=${SMTP_SECURE_SOCKET:-StartTls}
      - Smtp__UseSsl=false
      - Smtp__UseStartTls=true
    ports:
      - "5003:5003"
    depends_on:
      notification-db:
        condition: service_healthy
      identity-service:
        condition: service_healthy
    networks:
      - app-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5003/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Document Service
  document-service:
    build:
      context: ./Document
      dockerfile: Dockerfile
    container_name: document-service
    restart: unless-stopped
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:5004
      - ConnectionStrings__DefaultConnection=Host=document-db;Port=5432;Database=${DOCUMENT_DB_NAME:-DocumentDb};Username=${POSTGRES_USER:-postgres};Password=${POSTGRES_PASSWORD:-123123}
      - Jwt__SecretKey=${JWT_SECRET_KEY:-YourSuperSecretKeyThatIsAtLeast32CharactersLongForIdentityService!}
      - Jwt__Issuer=${JWT_ISSUER:-IdentityApp}
      - Jwt__Audience=${JWT_AUDIENCE:-IdentityAppClients}
      - Minio__Endpoint=${MINIO_ENDPOINT:-minio:9000}
      - Minio__AccessKey=${MINIO_ROOT_USER:-minioadmin}
      - Minio__SecretKey=${MINIO_ROOT_PASSWORD:-minioadmin}
      - Minio__UseSSL=${MINIO_USE_SSL:-false}
      - Minio__Bucket=${MINIO_BUCKET:-documents}
    ports:
      - "5004:5004"
    depends_on:
      document-db:
        condition: service_healthy
      minio:
        condition: service_healthy
    networks:
      - app-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5004/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # # Automation Service (AI Assistant) - DISABLED: source code missing
  # automation-service:
  #   build:
  #     context: ./Automation
  #     dockerfile: Dockerfile
  #   container_name: automation-service
  #   restart: unless-stopped
  #   environment:
  #     - ASPNETCORE_ENVIRONMENT=Production
  #     - ASPNETCORE_URLS=http://+:5006
  #     - ConnectionStrings__DefaultConnection=Host=automation-db;Port=5432;Database=${AUTOMATION_DB_NAME:-automationdb};Username=${POSTGRES_USER:-postgres};Password=${POSTGRES_PASSWORD:-123123}
  #     - IdentityService__BaseUrl=http://identity-service:5005
  #     - AppointmentService__BaseUrl=http://appointment-service:5001
  #     - Jwt__SecretKey=${JWT_SECRET_KEY:-YourSuperSecretKeyThatIsAtLeast32CharactersLongForIdentityService!}
  #     - Jwt__Issuer=${JWT_ISSUER:-IdentityApp}
  #     - Jwt__Audience=${JWT_AUDIENCE:-IdentityAppClients}
  #     - Groq__ApiKey=${GROQ_API_KEY}
  #   ports:
  #     - "5006:5006"
  #   depends_on:
  #     automation-db:
  #       condition: service_healthy
  #     identity-service:
  #       condition: service_healthy
  #     appointment-service:
  #       condition: service_healthy
  #   networks:
  #     - app-network
  #   healthcheck:
  #     test: ["CMD-SHELL", "curl -f http://localhost:5006/health || exit 1"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #     start_period: 40s

  # Frontend (React + Nginx)
  frontend:
    build:
      context: ./Frontend
      dockerfile: Dockerfile
    container_name: frontend
    restart: unless-stopped
    ports:
      - "8080:80"
    depends_on:
      - identity-service
      - appointment-service
      - chat-service
      - notification-service
      - document-service
    networks:
      - app-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:80 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  app-network:
    driver: bridge
    name: appointment-app-network

volumes:
  identity-db-data:
    name: identity-db-data
  appointment-db-data:
    name: appointment-db-data
  chat-db-data:
    name: chat-db-data
  notification-db-data:
    name: notification-db-data
  document-db-data:
    name: document-db-data
  automation-db-data:
    name: automation-db-data
  minio-data:
    name: minio-data
